# 🔧 网络连接问题修复方案

## 问题诊断结果

### ✅ 后端服务状态正常
所有Docker容器都在正常运行：
- `gateway-service`: http://localhost:8083 ✅
- `user-service`: http://localhost:8081 ✅ 
- `postgres`: localhost:5432 ✅
- `redis`: localhost:6379 ✅

### ✅ API端点测试通过
```bash
# 网关服务健康检查 - 成功
curl http://localhost:8083/health
# 返回: {"status":"healthy","service":"gateway-service","version":"1.0.0"}

# 小程序API健康检查 - 成功  
curl http://localhost:8083/api/v1/miniprogram/health
# 返回: {"code":0,"message":"小程序API网关正常运行",...}

# 登录API测试 - 成功
curl -X POST http://localhost:8083/api/v1/miniprogram/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code":"test","userInfo":{"nickName":"test"}}'
# 返回: {"code":0,"message":"登录成功",...}
```

## 问题根因分析

**网络连接正常，后端服务正常，问题出现在微信开发者工具的网络配置上。**

根据API路径分析：
- 小程序代码中使用: `/miniprogram/auth/login`
- 网关实际路径为: `/api/v1/miniprogram/auth/login`
- **路径不匹配导致404错误**

## 解决方案

### 方案1：修复环境配置文件（推荐）

修改 `src/miniprogram/config/env.js`：

```javascript
// config/env.js
const config = {
  development: {
    baseURL: 'http://localhost:8083',
    apiPrefix: '/api/v1',  // 确保API前缀正确
    timeout: 10000,
    debug: true
  }
  // ...
};

// 工具方法需要正确拼接路径
const getApiUrl = (path) => {
  const prefix = config[ENV].apiPrefix || '';
  // 确保路径拼接正确
  return prefix + path;
};
```

### 方案2：微信开发者工具网络设置

1. **打开微信开发者工具**
2. **点击右上角"详情"**
3. **选择"本地设置"**
4. **勾选"不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"**
5. **重启开发者工具**

### 方案3：验证网络连接

在微信开发者工具控制台中执行：

```javascript
// 测试基础连接
wx.request({
  url: 'http://localhost:8083/api/v1/miniprogram/health',
  success: (res) => {
    console.log('连接成功:', res.data);
  },
  fail: (error) => {
    console.log('连接失败:', error);
  }
});
```

## 验证步骤

1. **检查环境配置**：确保 `config/env.js` 中的API路径配置正确
2. **域名校验设置**：确保微信开发者工具已关闭域名校验
3. **重启工具**：重启微信开发者工具清除缓存
4. **功能测试**：点击"开始你的旅程"测试登录功能

## 预期结果

修复后，小程序应该能够：
- ✅ 成功连接到后端API
- ✅ 登录功能正常工作
- ✅ 不再出现"[Errno -2] Name or service not known"错误
- ✅ 网络请求返回正确的响应数据

## 注意事项

1. **路径匹配**：确保前端API调用路径与后端路由路径完全匹配
2. **CORS设置**：网关已配置CORS支持小程序跨域请求
3. **容器网络**：后端服务间通信使用Docker容器内网络（如user-service:8000）
4. **端口映射**：对外暴露的端口映射正确（8083->8000, 8081->8000）

通过以上修复方案，网络连接问题应该能够得到彻底解决。