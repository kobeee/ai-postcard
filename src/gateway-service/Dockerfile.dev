FROM python:3.11-slim

WORKDIR /app

# 复制依赖定义文件
COPY requirements.txt ./

# 创建虚拟环境并安装依赖
# 这一层会被缓存，只有 requirements.txt 变化时才会重新执行
RUN python3 -m venv .venv && \
    . .venv/bin/activate && \
    pip install --no-cache-dir -r requirements.txt

# 将虚拟环境路径加入PATH，后续命令可直接使用
ENV PATH="/app/.venv/bin:$PATH"

# 复制应用源代码
# 在 docker-compose.yml 中通过 volume 挂载，实现热更新
COPY ./app /app

EXPOSE 8000

CMD ["/app/.venv/bin/python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]