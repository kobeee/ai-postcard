<!-- postcard.wxml - 明信片详情页 -->
<view class="container">
  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 错误状态 -->
  <view class="error-container" wx:elif="{{error}}">
    <text class="error-icon">😕</text>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" type="primary" bindtap="handleRetry">重试</button>
  </view>

  <!-- 明信片内容 -->
  <view class="postcard-container" wx:else>
    
    <!-- 结构化明信片渲染（最高优先级） -->
    <view class="structured-card-section" wx:if="{{hasStructuredData}}">
      <structured-postcard 
        id="main-structured-postcard"
        class="main-structured-postcard"
        structured-data="{{structuredData}}"
        background-image="{{structuredData.visual.background_image_url || postcard.image_url}}"
        fallback-english="{{postcard.english}}"
        show-animation="{{true}}"
        size-mode="standard"
        bind:cardtap="onStructuredCardTap"
        bind:recommendationtap="onRecommendationTap"
        bind:share="onShareStructuredCard"
      ></structured-postcard>
      
    </view>

    <!-- 🔥 降级方案：全新超简单卡片 -->
    <view class="new-simple-card" wx:elif="{{postcard}}">
      <text class="simple-card-title">今日心情</text>
      <text class="card-content">{{postcard.content ? '内容解析中...' : '杭州夏夜，微风轻拂'}}</text>
      <text class="card-time">{{postcard.created_at || '2024年8月28日'}}</text>
      
      <!-- 降级提示 -->
      <view class="fallback-warning">
        <text class="warning-icon">⚠️</text>
        <text class="warning-text">数据解析失败，显示基础内容</text>
      </view>
    </view>
    

    <!-- 明信片信息 -->
    <view class="info-section">

      <view class="meta-card">
        <view class="meta-item">
          <text class="meta-label">创建时间：</text>
          <text class="meta-value">{{postcard.created_at}}</text>
        </view>
        <view class="meta-item" wx:if="{{postcard.ai_model}}">
          <text class="meta-label">AI模型：</text>
          <text class="meta-value">{{postcard.ai_model}}</text>
        </view>
        <view class="meta-item" wx:if="{{postcard.generation_time}}">
          <text class="meta-label">生成耗时：</text>
          <text class="meta-value">{{postcard.generation_time}}秒</text>
        </view>
      </view>

      <!-- 交互预览 -->
      <view class="interactive-card" wx:if="{{postcard.frontend_code}}">
        <view class="card-header">
          <text class="content-card-title">交互效果</text>
          <text class="preview-btn" bindtap="previewCode">🎭</text>
        </view>
        <text class="interactive-desc">这张明信片包含了动态交互效果</text>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="actions-section">
      <view class="action-row">
        <button class="action-btn secondary" bindtap="saveCardScreenshot">
          <text class="btn-icon">💾</text>
          <text class="btn-text">保存卡片</text>
        </button>
        <button class="action-btn danger" bindtap="handleDelete">
          <text class="btn-icon">🗑️</text>
          <text class="btn-text">删除明信片</text>
        </button>
      </view>
    </view>

    <!-- 隐藏的Canvas用于截图 -->
    <canvas canvas-id="shareCanvas" class="share-canvas"></canvas>
    <canvas canvas-id="screenshot-canvas" class="screenshot-canvas"></canvas>

    <!-- 底部信息 -->
    <view class="footer-section">
      <text class="footer-text">由 AI明信片 创作生成</text>
      <text class="footer-link" bindtap="goHome">创建更多明信片 ></text>
    </view>
  </view>
</view>