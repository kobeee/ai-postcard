<!-- postcard.wxml - æ˜ä¿¡ç‰‡è¯¦æƒ…é¡µ -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:elif="{{error}}">
    <text class="error-icon">ğŸ˜•</text>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" type="primary" bindtap="handleRetry">é‡è¯•</button>
  </view>

  <!-- æ˜ä¿¡ç‰‡å†…å®¹ -->
  <view class="postcard-container" wx:else>
    
    <!-- ğŸ”® å¿ƒè±¡ç­¾ä¸»æ˜¾ç¤ºåŒºåŸŸ - æŒ‚ä»¶å¼å¿ƒè±¡ç­¾ï¼ˆå®Œå…¨ç…§æ¬é¦–é¡µå®ç°ï¼‰ -->
    <view class="charm-main-area" wx:if="{{hasStructuredData && structuredData}}">
      <hanging-charm
        id="main-hanging-charm"
        oracle-data="{{postcard}}"
        charm-type="{{structuredData.ai_selected_charm_id || selectedCharmType || 'lianhua-yuanpai'}}"
        background-image="{{structuredData.visual_background_image || structuredData.image_url || postcard.image_url || postcard.image}}"
        show-animation="{{true}}"
        size-mode="large"
        bind:flip="onCharmFlip"
      ></hanging-charm>
    </view>

    <!-- é™çº§æ˜¾ç¤ºåŒºåŸŸï¼šä¼ ç»Ÿå¡ç‰‡ -->
    <view class="fallback-card-area" wx:elif="{{postcard && !hasStructuredData}}">
      <view class="beautiful-postcard {{postcard.layout_mode}}">
        <!-- èƒŒæ™¯å›¾å±‚ -->
        <view class="postcard-background">
          <image 
            class="background-image" 
            src="{{postcard.image || postcard.card_image || postcard.image_url}}" 
            mode="aspectFill"
            lazy-load="true"
          ></image>
          <view class="background-overlay"></view>
        </view>
        
        <!-- å†…å®¹å±‚ -->
        <view class="postcard-content">
          <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
          <view class="postcard-header">
            <text class="postcard-title">{{postcard.keyword || postcard.title || 'å¿ƒè±¡ç­¾'}}</text>
          </view>
          
          <!-- ä¸»æ–‡æ¡ˆåŒº -->
          <view class="postcard-body">
            <view class="main-quote">
              <text class="quote-text">{{postcard.quote || postcard.content || 'æ„Ÿå—ç”Ÿæ´»çš„è¯—æ„'}}</text>
            </view>
            <view class="english-ribbon" wx:if="{{postcard.english}}">
              <text class="english-text">{{postcard.english}}</text>
            </view>
          </view>
          
          <!-- åº•éƒ¨è£…é¥°åŒº -->
          <view class="postcard-footer">
            <view class="signature">
              <text class="signature-text">â€” å¿ƒè±¡ç­¾</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ğŸ”¥ é™çº§æ–¹æ¡ˆ2ï¼šå…¨æ–°è¶…ç®€å•å¡ç‰‡ -->
    <view class="new-simple-card" wx:elif="{{postcard}}">
      <text class="simple-card-title">ä»Šæ—¥å¿ƒæƒ…</text>
      <text class="card-content">{{postcard.content ? 'å†…å®¹è§£æä¸­...' : 'æ­å·å¤å¤œï¼Œå¾®é£è½»æ‹‚'}}</text>
      <text class="card-time">{{postcard.created_at || '2024å¹´8æœˆ28æ—¥'}}</text>
      
      <!-- é™çº§æç¤º -->
      <view class="fallback-warning">
        <text class="warning-icon">âš ï¸</text>
        <text class="warning-text">æ•°æ®è§£æå¤±è´¥ï¼Œæ˜¾ç¤ºåŸºç¡€å†…å®¹</text>
      </view>
    </view>
    

    <!-- æ˜ä¿¡ç‰‡ä¿¡æ¯ -->
    <view class="info-section">

      <view class="meta-card">
        <view class="meta-item">
          <text class="meta-label">åˆ›å»ºæ—¶é—´ï¼š</text>
          <text class="meta-value">{{postcard.created_at}}</text>
        </view>
        <view class="meta-item" wx:if="{{postcard.ai_model}}">
          <text class="meta-label">AIæ¨¡å‹ï¼š</text>
          <text class="meta-value">{{postcard.ai_model}}</text>
        </view>
        <view class="meta-item" wx:if="{{postcard.generation_time}}">
          <text class="meta-label">ç”Ÿæˆè€—æ—¶ï¼š</text>
          <text class="meta-value">{{postcard.generation_time}}ç§’</text>
        </view>
      </view>

      <!-- äº¤äº’é¢„è§ˆ -->
      <view class="interactive-card" wx:if="{{postcard.frontend_code}}">
        <view class="card-header">
          <text class="content-card-title">äº¤äº’æ•ˆæœ</text>
          <text class="preview-btn" bindtap="previewCode">ğŸ­</text>
        </view>
        <text class="interactive-desc">è¿™å¼ æ˜ä¿¡ç‰‡åŒ…å«äº†åŠ¨æ€äº¤äº’æ•ˆæœ</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="actions-section">
      <view class="action-row">
        <button class="action-btn secondary" bindtap="saveCardScreenshot">
          <text class="btn-icon">ğŸ’¾</text>
          <text class="btn-text">ä¿å­˜å¡ç‰‡</text>
        </button>
        <button class="action-btn danger" bindtap="handleDelete">
          <text class="btn-icon">ğŸ—‘ï¸</text>
          <text class="btn-text">åˆ é™¤å¿ƒè±¡ç­¾</text>
        </button>
      </view>
    </view>

    <!-- éšè—çš„Canvasç”¨äºæˆªå›¾ -->
    <canvas canvas-id="shareCanvas" class="share-canvas"></canvas>
    <canvas canvas-id="screenshot-canvas" class="screenshot-canvas"></canvas>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <view class="footer-section">
      <text class="footer-text">ç”± AIå¿ƒè±¡ç­¾ åˆ›ä½œç”Ÿæˆ</text>
      <text class="footer-link" bindtap="goHome">åˆ›å»ºæ›´å¤šå¿ƒè±¡ç­¾ ></text>
    </view>
  </view>
</view>