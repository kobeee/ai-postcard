<!-- index.wxml - 心象签首页 -->
<view class="page">
<view class="compass-container {{todayCard && todayCard.structured_data ? 'charm-mode' : ''}}">
  <!-- 背景装饰 -->
  <view class="bg-decoration">
    <view class="floating-particle" wx:for="{{particles}}" wx:key="id" style="--delay: {{item.delay}}s; --x: {{item.x}}%; --y: {{item.y}};"></view>
  </view>

  <!-- 用户状态区域 -->
  <view class="user-status" wx:if="{{hasUserInfo}}">
    <!-- 简洁头像：使用圆形容器 + 透明按钮覆盖，避免按钮样式影响形状 -->
    <view class="avatar-circle" aria-label="更换头像">
      <image class="avatar-image" src="{{userInfo.avatarUrl || userInfo.avatar_url}}" mode="aspectFill"></image>
      <button class="avatar-overlay-btn" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar"></button>
    </view>
    <text class="greeting-text">{{greetingText}}</text>
    <view class="date-info-container">
      <text class="date-info">{{currentDate}}</text>
    </view>
  </view>

  <!-- 登录界面 -->
  <view class="login-container" wx:if="{{!hasUserInfo}}">
    <view class="compass-logo">
      <view class="compass-ring">
        <view class="compass-needle"></view>
        <view class="compass-dot"></view>
      </view>
    </view>
    <view class="brand-text">
      <text class="brand-title">心象签</text>
      <text class="brand-subtitle" decode="{{true}}">将心情映射为自然意象，&#10;感受生活的诗意</text>
    </view>
    
    <!-- 简化登录按钮 -->
    <button class="login-btn" bindtap="handleQuickLogin" hover-class="login-btn-hover">
      <text class="login-text">开始体验</text>
    </button>
  </view>

  <!-- 🔮 心象签主显示区域 - 简化结构 -->
  <view class="charm-main-area" wx:if="{{hasUserInfo && todayCard && todayCard.structured_data}}">
    <hanging-charm
      id="main-hanging-charm"
      oracle-data="{{todayCard}}"
      charm-type="{{selectedCharmType || 'lianhua-yuanpai'}}"
      background-image="{{todayCard.visual_background_image || todayCard.image_url || todayCard.image}}"
      show-animation="{{true}}"
      size-mode="large"
      bind:flip="onCharmFlip"
    ></hanging-charm>
  </view>

  <!-- 降级显示区域：传统卡片 -->
  <view class="fallback-card-area" wx:elif="{{hasUserInfo && todayCard && !todayCard.structured_data}}">
    <view class="beautiful-postcard {{todayCard.layout_mode}}">
      <!-- 背景图层 -->
      <view class="postcard-background">
        <image 
          class="background-image" 
          src="{{todayCard.image || todayCard.card_image}}" 
          mode="aspectFill"
          lazy-load="true"
        ></image>
        <view class="background-overlay"></view>
      </view>
      
      <!-- 内容层 -->
      <view class="postcard-content">
        <!-- 顶部标题区 -->
        <view class="postcard-header">
          <text class="postcard-title">{{todayCard.keyword}}</text>
        </view>
        
        <!-- 主文案区 -->
        <view class="postcard-body">
          <view class="main-quote">
            <text class="quote-text">{{todayCard.quote}}</text>
          </view>
          <view class="english-ribbon" wx:if="{{todayCard.english}}">
            <text class="english-text">{{todayCard.english}}</text>
          </view>
        </view>
        
        <!-- 底部装饰区 -->
        <view class="postcard-footer">
          <view class="signature">
            <text class="signature-text">— 心象签</text>
          </view>
        </view>
      </view>
    </view>
  </view>
    

    <!-- 心象画笔区域 -->
    <view class="emotion-ink" wx:if="{{hasUserInfo && (!todayCard || needEmotionInput)}}">
      <view class="ink-title">
        <text class="title-main">心象画笔</text>
        <text class="title-sub">用直觉绘出内心的自然意象，让AI感知你的心境</text>
      </view>
      
      <canvas
        type="2d"
        id="emotionCanvas"
        class="ink-canvas"
        hidden="{{isGenerating || quizModalVisible}}"
        bind:touchstart="onInkStart"
        bind:touchmove="onInkMove"
        bind:touchend="onInkEnd"
        disable-scroll="true"
      ></canvas>
      
      <view class="ink-actions">
        <!-- 清空按钮 - 始终显示 -->
        <button class="ink-btn clear" bindtap="clearInk">清空</button>
        
        <!-- 动态主按钮区域 -->
        <view class="main-action-area">
          <!-- 状态1：未完成测试时显示测试按钮 -->
          <button 
            class="ink-btn quiz-primary" 
            bindtap="startQuiz" 
            wx:if="{{!quizCompleted && quizAnswers.length === 0}}">
            🔮 心境速测
          </button>
          
          <!-- 状态2：已完成测试，显示生成按钮 -->
          <button 
            class="ink-btn generate-primary {{isGenerating ? 'loading' : ''}} {{!environmentReady ? 'waiting' : ''}}" 
            bindtap="generateDailyCard" 
            disabled="{{isGenerating || !environmentReady}}"
            wx:elif="{{quizCompleted || quizAnswers.length > 0}}">
            <text wx:if="{{!environmentReady && !isGenerating}}">🌍 感知时空背景中...</text>
            <text wx:elif="{{!isGenerating}}">✨ 生成心象签</text>
            <text wx:else>🔮 AI感知自然意象中</text>
          </button>
        </view>
      </view>
    </view>
  
  <!-- 心象回廊 -->
  <view class="memory-gallery" wx:if="{{hasUserInfo && userCards.length > 0}}">
    <view class="gallery-header">
      <text class="gallery-title">心象回廊</text>
      <text class="gallery-count">{{userCards.length}} 张心象签</text>
    </view>
    
    <scroll-view class="gallery-scroll" scroll-x>
      <view 
        class="memory-card"
        wx:for="{{userCards}}"
        wx:key="id"
        bindtap="viewCard"
        data-card-id="{{item.id}}"
      >
        <!-- 卡片背景图片 -->
        <image 
          wx:if="{{item.backgroundImage}}"
          class="memory-bg"
          src="{{item.backgroundImage}}" 
          mode="aspectFill"
        ></image>
        <view class="memory-overlay"></view>
        
        <!-- 卡片内容 -->
        <view class="memory-content">
          <view class="memory-date">{{item.date}}</view>
          <view class="memory-title">{{item.keyword}}</view>
          <view class="memory-text" wx:if="{{item.mainText}}">{{item.mainText}}</view>
          <view class="memory-mood-label" wx:if="{{item.mood}}">{{item.mood}}</view>
        </view>
        
        <view class="memory-mood-bar" style="background: {{item.moodColor}}"></view>
      </view>
    </scroll-view>
  </view>
  
  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{hasUserInfo && !todayCard && !isGenerating}}">
    <view class="empty-compass">
      <view class="compass-ring empty">
        <view class="compass-needle inactive"></view>
      </view>
    </view>
    <text class="empty-title">今天还没有创建心象签</text>
    <text class="empty-subtitle">通过心象画笔，让AI感知你内心的自然意象</text>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{isGenerating}}">
    <view class="loading-compass">
      <view class="compass-ring loading">
        <view class="compass-needle spinning"></view>
      </view>
    </view>
    <text class="loading-text">{{loadingText}}</text>
    <view class="loading-steps">
      <view class="step {{currentStep >= 1 ? 'active' : ''}}">
        <text class="step-icon">🌍</text>
        <text class="step-text">感知时空</text>
      </view>
      <view class="step {{currentStep >= 2 ? 'active' : ''}}">
        <text class="step-icon">🎨</text>
        <text class="step-text">映射意象</text>
      </view>
      <view class="step {{currentStep >= 3 ? 'active' : ''}}">
        <text class="step-icon">✨</text>
        <text class="step-text">生成心象签</text>
      </view>
    </view>
  </view>
  
  <!-- 🔮 心境速测弹窗 -->
  <view class="quiz-modal-overlay" wx:if="{{showQuizModal}}" catchtap="closeQuizModal">
    <view class="quiz-modal" catchtap="stopPropagation">
      <!-- 弹窗头部 -->
      <view class="quiz-header">
        <view class="quiz-title">🔮 心境速测</view>
        <view class="quiz-progress">
          <text class="progress-text">{{currentQuestionIndex + 1}} / {{quizQuestions.length}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{(currentQuestionIndex + 1) / quizQuestions.length * 100}}%"></view>
          </view>
        </view>
        <button class="quiz-close" bindtap="closeQuizModal">×</button>
      </view>
      
      <!-- 问题内容 -->
      <view class="quiz-content" wx:if="{{quizQuestions.length > 0 && currentQuestionIndex < quizQuestions.length}}">
        <view class="question-container">
          <view class="question-text">{{quizQuestions[currentQuestionIndex].question}}</view>
          
          <!-- 选项列表 -->
          <view class="options-container">
            <view 
              class="option-item" 
              wx:for="{{quizQuestions[currentQuestionIndex].options}}" 
              wx:key="id"
              bindtap="selectQuizAnswer"
              data-question-id="{{quizQuestions[currentQuestionIndex].id}}"
              data-option-id="{{item.id}}"
              data-option-label="{{item.label}}"
            >
              <view class="option-label">{{item.label}}</view>
              <view class="option-icon">→</view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 完成状态 -->
      <view class="quiz-complete" wx:if="{{quizCompleted}}">
        <view class="complete-icon">✨</view>
        <view class="complete-text">心境速测完成</view>
        <view class="complete-subtitle">AI将更好地理解你的当下状态</view>
      </view>
      
      <!-- 底部操作 -->
      <view class="quiz-footer">
        <button class="quiz-skip-btn" bindtap="skipQuiz" wx:if="{{!quizCompleted}}">跳过测试</button>
      </view>
    </view>
  </view>
</view>
</view>