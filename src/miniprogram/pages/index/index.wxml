<!-- index.wxml - å¿ƒè±¡ç­¾é¦–é¡µ -->
<view class="page">
<view class="compass-container {{todayCard && todayCard.structured_data ? 'charm-mode' : ''}}">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration">
    <view class="floating-particle" wx:for="{{particles}}" wx:key="id" style="--delay: {{item.delay}}s; --x: {{item.x}}%; --y: {{item.y}};"></view>
  </view>

  <!-- ç”¨æˆ·çŠ¶æ€åŒºåŸŸ -->
  <view class="user-status" wx:if="{{hasUserInfo}}">
    <!-- ç®€æ´å¤´åƒï¼šä½¿ç”¨åœ†å½¢å®¹å™¨ + é€æ˜æŒ‰é’®è¦†ç›–ï¼Œé¿å…æŒ‰é’®æ ·å¼å½±å“å½¢çŠ¶ -->
    <view class="avatar-circle" aria-label="æ›´æ¢å¤´åƒ">
      <image class="avatar-image" src="{{userInfo.avatarUrl || userInfo.avatar_url}}" mode="aspectFill"></image>
      <button class="avatar-overlay-btn" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar"></button>
    </view>
    <text class="greeting-text">{{greetingText}}</text>
    <view class="date-info-container">
      <text class="date-info">{{currentDate}}</text>
    </view>
  </view>

  <!-- ç™»å½•ç•Œé¢ -->
  <view class="login-container" wx:if="{{!hasUserInfo}}">
    <view class="compass-logo">
      <view class="compass-ring">
        <view class="compass-needle"></view>
        <view class="compass-dot"></view>
      </view>
    </view>
    <view class="brand-text">
      <text class="brand-title">å¿ƒè±¡ç­¾</text>
      <text class="brand-subtitle" decode="{{true}}">å°†å¿ƒæƒ…æ˜ å°„ä¸ºè‡ªç„¶æ„è±¡ï¼Œ&#10;æ„Ÿå—ç”Ÿæ´»çš„è¯—æ„</text>
    </view>
    
    <!-- ç®€åŒ–ç™»å½•æŒ‰é’® -->
    <button class="login-btn" bindtap="handleQuickLogin" hover-class="login-btn-hover">
      <text class="login-text">å¼€å§‹ä½“éªŒ</text>
    </button>
  </view>

  <!-- ğŸ”® å¿ƒè±¡ç­¾ä¸»æ˜¾ç¤ºåŒºåŸŸ - ç®€åŒ–ç»“æ„ -->
  <view class="charm-main-area" wx:if="{{hasUserInfo && todayCard && todayCard.structured_data}}">
    <hanging-charm
      id="main-hanging-charm"
      oracle-data="{{todayCard}}"
      charm-type="{{selectedCharmType || 'lianhua-yuanpai'}}"
      background-image="{{todayCard.visual_background_image || todayCard.image_url || todayCard.image}}"
      show-animation="{{true}}"
      size-mode="large"
      bind:flip="onCharmFlip"
    ></hanging-charm>
  </view>

  <!-- é™çº§æ˜¾ç¤ºåŒºåŸŸï¼šä¼ ç»Ÿå¡ç‰‡ -->
  <view class="fallback-card-area" wx:elif="{{hasUserInfo && todayCard && !todayCard.structured_data}}">
    <view class="beautiful-postcard {{todayCard.layout_mode}}">
      <!-- èƒŒæ™¯å›¾å±‚ -->
      <view class="postcard-background">
        <image 
          class="background-image" 
          src="{{todayCard.image || todayCard.card_image}}" 
          mode="aspectFill"
          lazy-load="true"
        ></image>
        <view class="background-overlay"></view>
      </view>
      
      <!-- å†…å®¹å±‚ -->
      <view class="postcard-content">
        <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
        <view class="postcard-header">
          <text class="postcard-title">{{todayCard.keyword}}</text>
        </view>
        
        <!-- ä¸»æ–‡æ¡ˆåŒº -->
        <view class="postcard-body">
          <view class="main-quote">
            <text class="quote-text">{{todayCard.quote}}</text>
          </view>
          <view class="english-ribbon" wx:if="{{todayCard.english}}">
            <text class="english-text">{{todayCard.english}}</text>
          </view>
        </view>
        
        <!-- åº•éƒ¨è£…é¥°åŒº -->
        <view class="postcard-footer">
          <view class="signature">
            <text class="signature-text">â€” å¿ƒè±¡ç­¾</text>
          </view>
        </view>
      </view>
    </view>
  </view>
    

    <!-- å¿ƒè±¡ç”»ç¬”åŒºåŸŸ -->
    <view class="emotion-ink" wx:if="{{hasUserInfo && (!todayCard || needEmotionInput)}}">
      <view class="ink-title">
        <text class="title-main">å¿ƒè±¡ç”»ç¬”</text>
        <text class="title-sub">ç”¨ç›´è§‰ç»˜å‡ºå†…å¿ƒçš„è‡ªç„¶æ„è±¡ï¼Œè®©AIæ„ŸçŸ¥ä½ çš„å¿ƒå¢ƒ</text>
      </view>
      
      <canvas
        type="2d"
        id="emotionCanvas"
        class="ink-canvas"
        hidden="{{isGenerating || quizModalVisible}}"
        bind:touchstart="onInkStart"
        bind:touchmove="onInkMove"
        bind:touchend="onInkEnd"
        disable-scroll="true"
      ></canvas>
      
      <view class="ink-actions">
        <!-- æ¸…ç©ºæŒ‰é’® - å§‹ç»ˆæ˜¾ç¤º -->
        <button class="ink-btn clear" bindtap="clearInk">æ¸…ç©º</button>
        
        <!-- åŠ¨æ€ä¸»æŒ‰é’®åŒºåŸŸ -->
        <view class="main-action-area">
          <!-- çŠ¶æ€1ï¼šæœªå®Œæˆæµ‹è¯•æ—¶æ˜¾ç¤ºæµ‹è¯•æŒ‰é’® -->
          <button 
            class="ink-btn quiz-primary" 
            bindtap="startQuiz" 
            wx:if="{{!quizCompleted && quizAnswers.length === 0}}">
            ğŸ”® å¿ƒå¢ƒé€Ÿæµ‹
          </button>
          
          <!-- çŠ¶æ€2ï¼šå·²å®Œæˆæµ‹è¯•ï¼Œæ˜¾ç¤ºç”ŸæˆæŒ‰é’® -->
          <button 
            class="ink-btn generate-primary {{isGenerating ? 'loading' : ''}} {{!environmentReady ? 'waiting' : ''}}" 
            bindtap="generateDailyCard" 
            disabled="{{isGenerating || !environmentReady}}"
            wx:elif="{{quizCompleted || quizAnswers.length > 0}}">
            <text wx:if="{{!environmentReady && !isGenerating}}">ğŸŒ æ„ŸçŸ¥æ—¶ç©ºèƒŒæ™¯ä¸­...</text>
            <text wx:elif="{{!isGenerating}}">âœ¨ ç”Ÿæˆå¿ƒè±¡ç­¾</text>
            <text wx:else>ğŸ”® AIæ„ŸçŸ¥è‡ªç„¶æ„è±¡ä¸­</text>
          </button>
        </view>
      </view>
    </view>
  
  <!-- å¿ƒè±¡å›å»Š -->
  <view class="memory-gallery" wx:if="{{hasUserInfo && userCards.length > 0}}">
    <view class="gallery-header">
      <text class="gallery-title">å¿ƒè±¡å›å»Š</text>
      <text class="gallery-count">{{userCards.length}} å¼ å¿ƒè±¡ç­¾</text>
    </view>
    
    <scroll-view class="gallery-scroll" scroll-x>
      <view 
        class="memory-card"
        wx:for="{{userCards}}"
        wx:key="id"
        bindtap="viewCard"
        data-card-id="{{item.id}}"
      >
        <!-- å¡ç‰‡èƒŒæ™¯å›¾ç‰‡ -->
        <image 
          wx:if="{{item.backgroundImage}}"
          class="memory-bg"
          src="{{item.backgroundImage}}" 
          mode="aspectFill"
        ></image>
        <view class="memory-overlay"></view>
        
        <!-- å¡ç‰‡å†…å®¹ -->
        <view class="memory-content">
          <view class="memory-date">{{item.date}}</view>
          <view class="memory-title">{{item.keyword}}</view>
          <view class="memory-text" wx:if="{{item.mainText}}">{{item.mainText}}</view>
          <view class="memory-mood-label" wx:if="{{item.mood}}">{{item.mood}}</view>
        </view>
        
        <view class="memory-mood-bar" style="background: {{item.moodColor}}"></view>
      </view>
    </scroll-view>
  </view>
  
  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{hasUserInfo && !todayCard && !isGenerating}}">
    <view class="empty-compass">
      <view class="compass-ring empty">
        <view class="compass-needle inactive"></view>
      </view>
    </view>
    <text class="empty-title">ä»Šå¤©è¿˜æ²¡æœ‰åˆ›å»ºå¿ƒè±¡ç­¾</text>
    <text class="empty-subtitle">é€šè¿‡å¿ƒè±¡ç”»ç¬”ï¼Œè®©AIæ„ŸçŸ¥ä½ å†…å¿ƒçš„è‡ªç„¶æ„è±¡</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{isGenerating}}">
    <view class="loading-compass">
      <view class="compass-ring loading">
        <view class="compass-needle spinning"></view>
      </view>
    </view>
    <text class="loading-text">{{loadingText}}</text>
    <view class="loading-steps">
      <view class="step {{currentStep >= 1 ? 'active' : ''}}">
        <text class="step-icon">ğŸŒ</text>
        <text class="step-text">æ„ŸçŸ¥æ—¶ç©º</text>
      </view>
      <view class="step {{currentStep >= 2 ? 'active' : ''}}">
        <text class="step-icon">ğŸ¨</text>
        <text class="step-text">æ˜ å°„æ„è±¡</text>
      </view>
      <view class="step {{currentStep >= 3 ? 'active' : ''}}">
        <text class="step-icon">âœ¨</text>
        <text class="step-text">ç”Ÿæˆå¿ƒè±¡ç­¾</text>
      </view>
    </view>
  </view>
  
  <!-- ğŸ”® å¿ƒå¢ƒé€Ÿæµ‹å¼¹çª— -->
  <view class="quiz-modal-overlay" wx:if="{{showQuizModal}}" catchtap="closeQuizModal">
    <view class="quiz-modal" catchtap="stopPropagation">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="quiz-header">
        <view class="quiz-title">ğŸ”® å¿ƒå¢ƒé€Ÿæµ‹</view>
        <view class="quiz-progress">
          <text class="progress-text">{{currentQuestionIndex + 1}} / {{quizQuestions.length}}</text>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{(currentQuestionIndex + 1) / quizQuestions.length * 100}}%"></view>
          </view>
        </view>
        <button class="quiz-close" bindtap="closeQuizModal">Ã—</button>
      </view>
      
      <!-- é—®é¢˜å†…å®¹ -->
      <view class="quiz-content" wx:if="{{quizQuestions.length > 0 && currentQuestionIndex < quizQuestions.length}}">
        <view class="question-container">
          <view class="question-text">{{quizQuestions[currentQuestionIndex].question}}</view>
          
          <!-- é€‰é¡¹åˆ—è¡¨ -->
          <view class="options-container">
            <view 
              class="option-item" 
              wx:for="{{quizQuestions[currentQuestionIndex].options}}" 
              wx:key="id"
              bindtap="selectQuizAnswer"
              data-question-id="{{quizQuestions[currentQuestionIndex].id}}"
              data-option-id="{{item.id}}"
              data-option-label="{{item.label}}"
            >
              <view class="option-label">{{item.label}}</view>
              <view class="option-icon">â†’</view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å®ŒæˆçŠ¶æ€ -->
      <view class="quiz-complete" wx:if="{{quizCompleted}}">
        <view class="complete-icon">âœ¨</view>
        <view class="complete-text">å¿ƒå¢ƒé€Ÿæµ‹å®Œæˆ</view>
        <view class="complete-subtitle">AIå°†æ›´å¥½åœ°ç†è§£ä½ çš„å½“ä¸‹çŠ¶æ€</view>
      </view>
      
      <!-- åº•éƒ¨æ“ä½œ -->
      <view class="quiz-footer">
        <button class="quiz-skip-btn" bindtap="skipQuiz" wx:if="{{!quizCompleted}}">è·³è¿‡æµ‹è¯•</button>
      </view>
    </view>
  </view>
</view>
</view>