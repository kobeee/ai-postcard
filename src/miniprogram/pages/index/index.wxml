<!-- index.wxml - æƒ…ç»ªç½—ç›˜é¦–é¡µ -->
<view class="page">
<view class="compass-container">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration">
    <view class="floating-particle" wx:for="{{particles}}" wx:key="id" style="--delay: {{item.delay}}s; --x: {{item.x}}%; --y: {{item.y}};"></view>
  </view>

  <!-- ç”¨æˆ·çŠ¶æ€åŒºåŸŸ -->
  <view class="user-status" wx:if="{{hasUserInfo}}">
    <view class="avatar-ring">
      <image class="user-avatar" src="{{userInfo.avatar_url || userInfo.avatarUrl}}" mode="aspectFill"></image>
      <view class="ring-glow"></view>
    </view>
    <text class="greeting-text">{{greetingText}}</text>
    <view class="date-info-container">
      <text class="date-info">{{currentDate}} Â· {{weatherInfo}}</text>
      <view class="env-status" wx:if="{{!environmentReady}}">
        <text class="status-dot loading"></text>
        <text class="status-text">ç¯å¢ƒä¿¡æ¯è·å–ä¸­</text>
      </view>
      <view class="env-status" wx:elif="{{environmentReady}}">
        <text class="status-dot"></text>
        <text class="status-text">ç¯å¢ƒä¿¡æ¯å·²è·å–</text>
      </view>
    </view>
  </view>

  <!-- ç™»å½•ç•Œé¢ -->
  <view class="login-container" wx:if="{{!hasUserInfo}}">
    <view class="compass-logo">
      <view class="compass-ring">
        <view class="compass-needle"></view>
        <view class="compass-dot"></view>
      </view>
    </view>
    <view class="brand-text">
      <text class="brand-title">æƒ…ç»ªç½—ç›˜</text>
      <text class="brand-subtitle">æ¯ä¸€å¤©ï¼Œéƒ½å€¼å¾—è¢«æ¸©æŸ”è®°å½•</text>
    </view>
    
    <!-- ç™»å½•æŒ‰é’®ï¼šç›´æ¥å‘èµ·å¾®ä¿¡æˆæƒå¹¶ç™»å½• -->
    <button class="login-btn" bindtap="handleLogin" hover-class="login-btn-hover">
      <text class="login-text">ä½¿ç”¨å¾®ä¿¡ç™»å½•</text>
    </button>
  </view>

  <!-- æ ¸å¿ƒå¡ç‰‡åŒºåŸŸ -->
  <view class="card-container" wx:if="{{hasUserInfo}}">
    <!-- ä»Šæ—¥å¡ç‰‡ -->
    <view class="daily-card" wx:if="{{todayCard}}">
      <!-- ç»“æ„åŒ–å¡ç‰‡å±•ç¤º -->
      <view class="card-display-area" wx:if="{{todayCard}}">
        <!-- ä½¿ç”¨ç»“æ„åŒ–å¡ç‰‡ç»„ä»¶ï¼ˆå¦‚æœæœ‰ç»“æ„åŒ–æ•°æ®ï¼‰ -->
        <structured-postcard 
          wx:if="{{todayCard.structured_data}}"
          structured-data="{{todayCard.structured_data}}"
          background-image="{{todayCard.structured_data && todayCard.structured_data.visual && todayCard.structured_data.visual.background_image_url || todayCard.image || todayCard.card_image}}"
          fallback-english="{{todayCard.english}}"
          show-animation="{{false}}"
          size-mode="standard"
          bind:recommendationtap="onRecommendationTap"
          bind:share="onStructuredCardShare"
        ></structured-postcard>

        <!-- é™çº§æ˜¾ç¤ºï¼šç¾åŒ–çš„å¡ç‰‡å¸ƒå±€ï¼ˆç»“åˆèƒŒæ™¯å›¾å’Œæ–‡æ¡ˆï¼‰ -->
        <view class="beautiful-postcard {{todayCard.layout_mode}}" wx:elif="{{!todayCard.structured_data}}">
          <!-- èƒŒæ™¯å›¾å±‚ -->
          <view class="postcard-background">
            <image 
              class="background-image" 
              src="{{todayCard.image || todayCard.card_image}}" 
              mode="aspectFill"
              lazy-load="true"
            ></image>
            <view class="background-overlay"></view>
          </view>
          
          <!-- å†…å®¹å±‚ -->
          <view class="postcard-content">
            <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
            <view class="postcard-header">
              <text class="postcard-title">{{todayCard.keyword}}</text>
            </view>
            
            <!-- ä¸»æ–‡æ¡ˆåŒº -->
            <view class="postcard-body">
              <view class="main-quote">
                <text class="quote-text">{{todayCard.quote}}</text>
              </view>
              <view class="english-ribbon" wx:if="{{todayCard.english}}">
                <text class="english-text">{{todayCard.english}}</text>
              </view>
            </view>
            
            <!-- æ¨èå†…å®¹åŒº -->
            <view class="postcard-recommendations" wx:if="{{todayCard.hasRecommendations}}">
              <view class="recommendations-title">
                <text class="rec-title-text">âœ¨ ä»Šæ—¥æ¨è</text>
              </view>
              
              <!-- éŸ³ä¹æ¨è -->
              <view class="recommendation-item" wx:if="{{todayCard.music}}">
                <text class="rec-icon">ğŸµ</text>
                <view class="rec-content">
                  <text class="rec-name">{{todayCard.music.title}}</text>
                  <text class="rec-author" wx:if="{{todayCard.music.artist}}">{{todayCard.music.artist}}</text>
                </view>
              </view>
              
              <!-- ä¹¦ç±æ¨è -->
              <view class="recommendation-item" wx:if="{{todayCard.book}}">
                <text class="rec-icon">ğŸ“š</text>
                <view class="rec-content">
                  <text class="rec-name">{{todayCard.book.title}}</text>
                  <text class="rec-author" wx:if="{{todayCard.book.author}}">{{todayCard.book.author}}</text>
                </view>
              </view>
              
              <!-- ç”µå½±æ¨è -->
              <view class="recommendation-item" wx:if="{{todayCard.movie}}">
                <text class="rec-icon">ğŸ¬</text>
                <view class="rec-content">
                  <text class="rec-name">{{todayCard.movie.title}}</text>
                  <text class="rec-author" wx:if="{{todayCard.movie.director}}">{{todayCard.movie.director}}</text>
                </view>
              </view>
            </view>
            
            <!-- åº•éƒ¨è£…é¥°åŒº -->
            <view class="postcard-footer">
              <view class="signature">
                <text class="signature-text">â€” æƒ…ç»ªç½—ç›˜</text>
              </view>
            </view>
          </view>

        </view>
      </view>
      
      <!-- ä¼ ç»Ÿå¡ç‰‡å¸ƒå±€ï¼ˆé™çº§æ–¹æ¡ˆï¼‰ -->
      <view class="traditional-card" wx:else>
        <!-- æ­£é¢ -->
        <view class="card-front">
          <view class="card-date">{{todayCard.date}}</view>
          <view class="card-keyword">{{todayCard.keyword}}</view>
          <view class="card-quote">{{todayCard.quote}}</view>
          <view class="card-english">{{todayCard.english}}</view>
        
        <view class="card-recommendations">
          <view class="rec-item" wx:if="{{todayCard.music}}" bindtap="playMusic" data-url="{{todayCard.music.url}}">
            <text class="rec-icon">ğŸµ</text>
            <text class="rec-text">{{todayCard.music.title}}</text>
          </view>
          
          <view class="rec-item" wx:if="{{todayCard.movie}}">
            <text class="rec-icon">ğŸ¬</text>
            <text class="rec-text">{{todayCard.movie}}</text>
          </view>
          
          <view class="rec-item" wx:if="{{todayCard.book}}">
            <text class="rec-icon">ğŸ“š</text>
            <text class="rec-text">{{todayCard.book}}</text>
          </view>
        </view>
        
        <view class="flip-hint">
          <text class="hint-icon">ğŸ”</text>
          <text class="hint-text">è½»è§¦æ­ç§˜</text>
        </view>
      </view>
      
      <!-- èƒŒé¢ -->
      <view class="card-back">
        <view class="back-title">åˆ›ä½œçµæ„Ÿ</view>
        <view class="inspiration-list">
          <view class="inspiration-item" wx:for="{{todayCard.inspirations}}" wx:key="*this">
            <text class="ins-icon">{{item.icon}}</text>
            <text class="ins-text">{{item.text}}</text>
          </view>
        </view>
        <view class="back-footer">
          <text class="compass-signature">â€”â€” æƒ…ç»ªç½—ç›˜</text>
        </view>
      </view>
      </view>
    </view>
    
    <!-- æƒ…ç»ªå¢¨è¿¹åŒºåŸŸ -->
    <view class="emotion-ink" wx:if="{{!todayCard || needEmotionInput}}">
      <view class="ink-title">
        <text class="title-main">ä»Šæ—¥æƒ…ç»ªå¢¨è¿¹</text>
        <text class="title-sub">ç”¨ä½ çš„ç›´è§‰ï¼Œåœ¨å±å¹•ä¸Šç”»ä¸‹æ­¤åˆ»çš„æ„Ÿå—</text>
      </view>
      
      <canvas 
        class="ink-canvas" 
        canvas-id="emotionCanvas"
        hidden="{{isGenerating}}"
        bind:touchstart="onInkStart"
        bind:touchmove="onInkMove"
        bind:touchend="onInkEnd"
        disable-scroll="true"
      ></canvas>
      
      <view class="ink-actions">
        <button class="ink-btn clear" bindtap="clearInk">æ¸…ç©º</button>
        <button class="ink-btn generate {{isGenerating ? 'loading' : ''}} {{!environmentReady ? 'waiting' : ''}}" bindtap="generateDailyCard" disabled="{{isGenerating || !environmentReady}}">
          <text wx:if="{{!environmentReady && !isGenerating}}">ğŸŒ è·å–ç¯å¢ƒä¿¡æ¯ä¸­...</text>
          <text wx:elif="{{!isGenerating}}">âœ¨ ç”Ÿæˆå¡ç‰‡</text>
          <text wx:else>ğŸŒŸ AIæ„ŸçŸ¥ä¸­</text>
        </button>
      </view>
    </view>
  </view>
  
  <!-- è®°å¿†å›å»Š -->
  <view class="memory-gallery" wx:if="{{hasUserInfo && userCards.length > 0}}">
    <view class="gallery-header">
      <text class="gallery-title">è®°å¿†å›å»Š</text>
      <text class="gallery-count">{{userCards.length}} å¼ å›å¿†</text>
    </view>
    
    <scroll-view class="gallery-scroll" scroll-x>
      <view 
        class="memory-card"
        wx:for="{{userCards}}"
        wx:key="id"
        bindtap="viewCard"
        data-card-id="{{item.id}}"
      >
        <!-- å¡ç‰‡èƒŒæ™¯å›¾ç‰‡ -->
        <image 
          wx:if="{{item.backgroundImage}}"
          class="memory-bg"
          src="{{item.backgroundImage}}" 
          mode="aspectFill"
        ></image>
        <view class="memory-overlay"></view>
        
        <!-- å¡ç‰‡å†…å®¹ -->
        <view class="memory-content">
          <view class="memory-date">{{item.date}}</view>
          <view class="memory-title">{{item.keyword}}</view>
          <view class="memory-text" wx:if="{{item.mainText}}">{{item.mainText}}</view>
          <view class="memory-mood-label" wx:if="{{item.mood}}">{{item.mood}}</view>
        </view>
        
        <view class="memory-mood-bar" style="background: {{item.moodColor}}"></view>
      </view>
    </scroll-view>
  </view>
  
  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{hasUserInfo && !todayCard && !isGenerating}}">
    <view class="empty-compass">
      <view class="compass-ring empty">
        <view class="compass-needle inactive"></view>
      </view>
    </view>
    <text class="empty-title">ä»Šå¤©è¿˜æ²¡æœ‰åˆ›å»ºå¡ç‰‡</text>
    <text class="empty-subtitle">é€šè¿‡æƒ…ç»ªå¢¨è¿¹ï¼Œè®©æˆ‘æ„ŸçŸ¥ä½ çš„ä»Šå¤©</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{isGenerating}}">
    <view class="loading-compass">
      <view class="compass-ring loading">
        <view class="compass-needle spinning"></view>
      </view>
    </view>
    <text class="loading-text">{{loadingText}}</text>
    <view class="loading-steps">
      <view class="step {{currentStep >= 1 ? 'active' : ''}}">
        <text class="step-icon">ğŸŒ</text>
        <text class="step-text">æ„ŸçŸ¥ç¯å¢ƒ</text>
      </view>
      <view class="step {{currentStep >= 2 ? 'active' : ''}}">
        <text class="step-icon">ğŸ¨</text>
        <text class="step-text">åˆ›æ„æ„æ€</text>
      </view>
      <view class="step {{currentStep >= 3 ? 'active' : ''}}">
        <text class="step-icon">âœ¨</text>
        <text class="step-text">é­”æ³•ç”Ÿæˆ</text>
      </view>
    </view>
  </view>
</view>
</view>