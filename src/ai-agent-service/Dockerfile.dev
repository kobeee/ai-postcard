FROM python:3.11-slim
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PATH="/app/.venv/bin:$PATH"

# 安装基础系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && python -m venv .venv

# 复制并安装 Python 依赖（构建阶段完成，保证 worker 可直接运行）
COPY requirements.txt ./
RUN . .venv/bin/activate && pip install --timeout=120 -r requirements.txt

# 安装Node.js 18 (分步进行，避免网络问题)
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get update \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# 安装Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# 安装 Puppeteer 用于 HTML->Image 转换（下载Chromium，镜像较大）
RUN npm install -g puppeteer

# 复制前端package.json并安装依赖（利用Docker缓存）
COPY app/frontend/package.json app/frontend/package-lock.json* /app/app/frontend/
RUN cd /app/app/frontend && npm install

# 创建和配置非root用户
RUN useradd -m -d /home/aiuser -s /bin/bash aiuser

# 1. 预先创建应用需要写入的所有目录
RUN mkdir -p /app/app/static/generated \
    && mkdir -p /app/app/static/assets \
    && mkdir -p /app/logs 

# 2. 一次性将 /app 下所有文件和目录的所有权赋予 aiuser
RUN chown -R aiuser:aiuser /app

# 3. 为需要写入的目录明确赋予 755 权限
RUN chmod -R 755 /app/app/static/generated \
    && chmod -R 755 /app/app/static/assets \
    && chmod -R 755 /app/logs

# 4. 切换到非root用户
USER aiuser

# 启动脚本：安装Python依赖、构建前端、运行服务
CMD ["sh", "-c", ". .venv/bin/activate && pip install --timeout=120 -r requirements.txt && cd app/frontend && npm run build && cd ../.. && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"]
